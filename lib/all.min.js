"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectWithoutProperties(e,t){var i={};for(var o in e)t.indexOf(o)>=0||Object.prototype.hasOwnProperty.call(e,o)&&(i[o]=e[o]);return i}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}(),WebSocket=require("universal-websocket-client"),CockpitRealTime=function(){function e(t){var i=t.host,o=t.protocol,n=void 0===o?"refresh-protocol":o;_classCallCheck(this,e),this.websocket=new WebSocket(i,n)}return _createClass(e,[{key:"on",value:function(t,i,o){e.isValidEvent(t)?(this.websocket.addEventListener("message",function(o){var n=JSON.parse(o.data);n.event.replace(e.eventPrefix,"")===t&&i(Object.assign({},n,{event:n.event}))}),this.websocket.addEventListener("error",o)):console.warn("Invalid event:",t)}}],[{key:"isValidEvent",value:function(t){if(!t)return!1;if(Object.values(e.events).includes(t))return!0;return Object.values(e.events).filter(function(e){return e.includes(".%s")}).map(function(e){return e.replace(".%s","")}).includes(t.split(".").slice(0,-1).join("."))}}]),e}();CockpitRealTime.events={CONNECT:"connect",REGIONS_SAVE_AFTER:"regions.save.after",REGIONS_REMOVE_AFTER:"regions.remove.after",COLLECTIONS_SAVE_AFTER:"collections.save.after",COLLECTIONS_SAVE_AFTER_NAME:"collections.save.after.%s",COLLECTIONS_REMOVE_AFTER:"collections.remove.after",COLLECTIONS_PREVIEW:"collections.preview"},CockpitRealTime.eventPrefix="cockpit:",module.exports=CockpitRealTime,Object.defineProperty(exports,"__esModule",{value:!0});_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}();var _queryString=require("query-string"),_queryString2=_interopRequireDefault(_queryString),_isomorphicFetch=require("isomorphic-fetch"),_isomorphicFetch2=_interopRequireDefault(_isomorphicFetch),CockpitSDK=function(){function e(t){var i=t.accessToken,o=t.defaultOptions,n=t.fetchInitOptions,a=t.host,r=t.lang,c=t.webSocket,s=_objectWithoutProperties(t,["accessToken","defaultOptions","fetchInitOptions","host","lang","webSocket"]);_classCallCheck(this,e),this.defaultOptions={},this.fetchInitOptions={mode:"cors",cache:"default"},this.getImageOptions=function(e){return"number"==typeof e?{width:e}:e};var u=Object.keys(s);u.length&&console.error("Invalid keys:",u,"\n","Valid keys are:","accessToken, defaultOptions, fetchInitOptions, host, lang, webSocket"),this.host=a,this.lang=r,this.fetchInitOptions=Object.assign({},this.fetchInitOptions,n),this.defaultOptions=Object.assign({},this.defaultOptions,o),this.accessToken=i,this.webSocket=c,this.queryParams={lang:this.lang,token:this.accessToken},c&&this.setWebsocket(c)}return _createClass(e,[{key:"fetchData",value:function(e,t,i){var o=Object.assign({},t,this.fetchInitOptions),n=""+this.host+e+"?"+_queryString2.default.stringify(this.queryParams)+"&"+_queryString2.default.stringify(i);return(0,_isomorphicFetch2.default)(n,o).then(function(e){return e.json()})}},{key:"fetchDataText",value:function(e,t,i){var o=Object.assign({},t,this.fetchInitOptions),n=""+this.host+e+"?"+_queryString2.default.stringify(this.queryParams)+"&"+_queryString2.default.stringify(i);return(0,_isomorphicFetch2.default)(n,o).then(function(e){return e.text()})}},{key:"collectionSchema",value:function(e){return this.fetchData("/api/collections/collection/"+e,{method:"GET"})}},{key:"collectionList",value:function(){return this.fetchData("/api/collections/listCollections",{method:"GET"})}},{key:"collectionGet",value:function(e,t){return this.fetchData("/api/collections/get/"+e,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(t)})}},{key:"collectionSave",value:function(e,t){return this.fetchData("/api/collections/save/"+e,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions({data:t})})}},{key:"collectionRemove",value:function(e,t){return this.fetchData("/api/collections/remove/"+e,{method:"POST",headers:{"Content-Type":"application/json"},filter:this.stringifyOptions(t)})}},{key:"stringifyOptions",value:function(e){return JSON.stringify(Object.assign({},this.defaultOptions,e))}},{key:"collection",value:function(e,t){var i=this;return{get:function(o,n){i.collectionGet(e,t).then(o).catch(n)},promise:new Promise(function(o,n){i.collectionGet(e,t).then(o).catch(n)}),schema:function(o,n){i.collectionSchema(e,t).then(o).catch(n)},watch:function(o,n){var a=function(){return i.collectionGet(e,t).then(o).catch(n)};a(),i.webSocket&&(i.webSocket.on(i.CockpitRealTime.events.COLLECTIONS_SAVE_AFTER,a,n),i.webSocket.on(i.CockpitRealTime.events.COLLECTIONS_SAVE_AFTER+"."+e,a,n))},on:function(e,t,o){var n={save:i.CockpitRealTime.events.COLLECTIONS_SAVE_AFTER,preview:i.CockpitRealTime.events.COLLECTIONS_PREVIEW};i.webSocket&&i.webSocket.on(n[e],t,o)}}}},{key:"regionGet",value:function(e){return this.fetchDataText("/api/regions/get/"+e,{method:"GET"})}},{key:"singletonList",value:function(){return this.fetchData("/api/singletons/listSingletons",{method:"GET"})}},{key:"singletonGet",value:function(e,t){return this.fetchData("/api/singletons/get/"+e,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(t)})}},{key:"regionList",value:function(){return this.fetchData("/api/regions/listRegions",{method:"GET"})}},{key:"regionData",value:function(e){return this.fetchData("/api/regions/data/"+e,{method:"GET"})}},{key:"region",value:function(e){var t=this;return{data:function(i,o){t.regionData(e).then(i).catch(o)},get:function(i,o){t.regionGet(e).then(i).catch(o)}}}},{key:"assets",value:function(e){return this.fetchData("/api/cockpit/assets",{method:"GET",headers:{"Content-Type":"application/json"}},e)}},{key:"imageGet",value:function(e,t){var i=t.width,o=t.height,n=t.quality;return this.fetchDataText("/api/cockpit/image",{method:"GET"},{src:e,w:i,h:o,q:n,d:1})}},{key:"image",value:function(e,t){if(!t||t==={}||t===[])return this.host+"/"+e;if(Array.isArray(t))return this.imageSrcSet(e,t);var i=this.getImageOptions(t),o=i.width,n=i.height,a=i.quality,r=i.pixelRatio,c=void 0===r?1:r,s=_objectWithoutProperties(i,["width","height","quality","pixelRatio"]);return this.host+"/api/cockpit/image?"+_queryString2.default.stringify(Object.assign({},this.queryParams,{src:e,w:o*c,h:n*c,q:a,d:1,o:1},s))}},{key:"imageSrcSet",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return i?i.map(function(i){if("string"==typeof i)return t.image(e,{width:i})+" "+i+"w";var o=i.srcSet,n=_objectWithoutProperties(i,["srcSet"]);return t.image(e,n)+" "+(o||n.width?""+(o||n.width+"w"):"")}).join(", "):""}},{key:"authUser",value:function(e,t){return this.fetchData("/api/cockpit/authUser",{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions({user:e,password:t})})}},{key:"listUsers",value:function(e){return this.fetchData("/api/cockpit/listUsers",{method:"GET",headers:{"Content-Type":"application/json"}},e)}},{key:"setWebsocket",value:function(e){this.CockpitRealTime=require("./CockpitRealTime"),this.webSocket=this.CockpitRealTime({host:e})}}]),e}();CockpitSDK.events={SAVE:"save",PREVIEW:"preview"},exports.default=CockpitSDK,Object.defineProperty(exports,"__esModule",{value:!0}),exports.CockpitRealTime=void 0;var _CockpitRealTime=require("./CockpitRealTime"),_CockpitRealTime2=_interopRequireDefault(_CockpitRealTime),_CockpitSDK2=_interopRequireDefault(_CockpitSDK=require("./CockpitSDK"));exports.default=_CockpitSDK2.default,exports.CockpitRealTime=_CockpitRealTime2.default;var _CockpitSDK;_CockpitSDK2=_interopRequireDefault(_CockpitSDK=require("../CockpitSDK"));test("Expect Cockpit.image to return height",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}).image("bux",{width:200,height:100});expect(e).toBe("foo/api/cockpit/image?d=1&h=100&lang=biz&o=1&src=bux&token=bar&w=200")}),test("Expect Cockpit.image with pixel ratio",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}).image("bux",{width:200,height:100,pixelRatio:2});expect(e).toBe("foo/api/cockpit/image?d=1&h=200&lang=biz&o=1&src=bux&token=bar&w=400")}),test("Expect Cockpit.image with array to return height",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}).image("bux",[{width:200,height:100},{width:20,height:10}]);expect(e).toBe("foo/api/cockpit/image?d=1&h=100&lang=biz&o=1&src=bux&token=bar&w=200 200w, foo/api/cockpit/image?d=1&h=10&lang=biz&o=1&src=bux&token=bar&w=20 20w")}),test("Expect Cockpit.image with array to return pixel ratio",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}).image("bux",[{pixelRatio:2,width:200,height:100},{pixelRatio:2,width:20,height:10}]);expect(e).toBe("foo/api/cockpit/image?d=1&h=200&lang=biz&o=1&src=bux&token=bar&w=400 200w, foo/api/cockpit/image?d=1&h=20&lang=biz&o=1&src=bux&token=bar&w=40 20w")}),test("Expect Cockpit.image with array to return different srcSet",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}).image("bux",[{width:200,height:100,srcSet:"1x"},{pixelRatio:2,width:200,height:100,srcSet:"2x"}]);expect(e).toBe("foo/api/cockpit/image?d=1&h=100&lang=biz&o=1&src=bux&token=bar&w=200 1x, foo/api/cockpit/image?d=1&h=200&lang=biz&o=1&src=bux&token=bar&w=400 2x")});