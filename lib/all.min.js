"use strict";var _createClass=function(){function o(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,i){return t&&o(e.prototype,t),i&&o(e,i),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var WebSocket=require("universal-websocket-client"),CockpitRealTime=function(){function o(e){var t=e.host,e=e.protocol,e=void 0===e?"refresh-protocol":e;_classCallCheck(this,o),this.websocket=new WebSocket(t,e)}return _createClass(o,[{key:"on",value:function(t,i,e){o.isValidEvent(t)?(this.websocket.addEventListener("message",function(e){e=JSON.parse(e.data);e.event.replace(o.eventPrefix,"")===t&&i(Object.assign({},e,{event:e.event}))}),this.websocket.addEventListener("error",e)):console.warn("Invalid event:",t)}}],[{key:"isValidEvent",value:function(e){return!!e&&(!!Object.values(o.events).includes(e)||Object.values(o.events).filter(function(e){return e.includes(".%s")}).map(function(e){return e.replace(".%s","")}).includes(e.split(".").slice(0,-1).join(".")))}}]),o}();CockpitRealTime.events={CONNECT:"connect",REGIONS_SAVE_AFTER:"regions.save.after",REGIONS_REMOVE_AFTER:"regions.remove.after",COLLECTIONS_SAVE_AFTER:"collections.save.after",COLLECTIONS_SAVE_AFTER_NAME:"collections.save.after.%s",COLLECTIONS_REMOVE_AFTER:"collections.remove.after",COLLECTIONS_PREVIEW:"collections.preview"},CockpitRealTime.eventPrefix="cockpit:",module.exports=CockpitRealTime,Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function o(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,i){return t&&o(e.prototype,t),i&&o(e,i),e}}(),_queryString=require("query-string"),_queryString2=_interopRequireDefault(_queryString),_isomorphicFetch=require("isomorphic-fetch"),_isomorphicFetch2=_interopRequireDefault(_isomorphicFetch),_queryString3=require("./utils/queryString");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectWithoutProperties(e,t){var i,o={};for(i in e)0<=t.indexOf(i)||Object.prototype.hasOwnProperty.call(e,i)&&(o[i]=e[i]);return o}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var CockpitSDK=function(){function r(e){var t=e.accessToken,i=e.defaultOptions,o=e.fetchInitOptions,n=e.host,s=e.lang,a=e.webSocket,c=e.apiEndpoints,c=void 0===c?{}:c,e=_objectWithoutProperties(e,["accessToken","defaultOptions","fetchInitOptions","host","lang","webSocket","apiEndpoints"]);_classCallCheck(this,r),this.defaultEndpoints={cockpitAssets:"/api/cockpit/assets",cockpitAuthUser:"/api/cockpit/authUser",cockpitImage:"/api/cockpit/image",cockpitListUsers:"/api/cockpit/listUsers",collectionsCollection:"/api/collections/collection/",collectionsGet:"/api/collections/get/",collectionsListCollections:"/api/collections/listCollections",collectionsRemove:"/api/collections/remove/",collectionsSave:"/api/collections/save/",regionsData:"/api/regions/data/",regionsGet:"/api/regions/get/",regionsListRegions:"/api/regions/listRegions",singletonsGet:"/api/singletons/get/",singletonsListSingletons:"/api/singletons/listSingletons",formsSubmit:"/api/forms/submit/"},this.endpoints={},this.defaultOptions={},this.fetchInitOptions={mode:"cors",cache:"default"},this.getImageOptions=function(e){return"number"==typeof e?{width:e}:e};e=Object.keys(e);e.length&&console.error("Invalid keys:",e,"\n","Valid keys are:","accessToken, defaultOptions, fetchInitOptions, host, lang, webSocket"),this.host=n,this.lang=s,this.fetchInitOptions=Object.assign({},this.fetchInitOptions,o),this.defaultOptions=Object.assign({},this.defaultOptions,i),this.endpoints=Object.assign({},this.defaultEndpoints,c),this.accessToken=t,this.webSocket=a,this.queryParams={lang:this.lang,token:this.accessToken},a&&this.setWebsocket(a)}return _createClass(r,[{key:"fetchData",value:function(e,t,i){t=Object.assign({},t,this.fetchInitOptions),i=""+this.host+e+"?"+_queryString2.default.stringify(this.queryParams)+"&"+_queryString2.default.stringify(i);return(0,_isomorphicFetch2.default)(i,t).then(function(e){return e.json()})}},{key:"fetchDataText",value:function(e,t,i){t=Object.assign({},t,this.fetchInitOptions),i=""+this.host+e+"?"+_queryString2.default.stringify(this.queryParams)+"&"+_queryString2.default.stringify(i);return(0,_isomorphicFetch2.default)(i,t).then(function(e){return e.text()})}},{key:"collectionSchema",value:function(e){return this.fetchData(""+this.endpoints.collectionsCollection+e,{method:"GET"})}},{key:"collectionList",value:function(){return this.fetchData(this.endpoints.collectionsListCollections,{method:"GET"})}},{key:"collectionGet",value:function(e,t){return this.fetchData(""+this.endpoints.collectionsGet+e,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(t)})}},{key:"collectionSave",value:function(e,t){return this.fetchData(""+this.endpoints.collectionsSave+e,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions({data:t})})}},{key:"collectionRemove",value:function(e,t){return this.fetchData(""+this.endpoints.collectionsRemove+e,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(t)})}},{key:"stringifyOptions",value:function(e){return JSON.stringify(Object.assign({},this.defaultOptions,e))}},{key:"collection",value:function(o,n){var s=this;return{get:function(e,t){s.collectionGet(o,n).then(e).catch(t)},promise:new Promise(function(e,t){s.collectionGet(o,n).then(e).catch(t)}),schema:function(e,t){s.collectionSchema(o,n).then(e).catch(t)},watch:function(e,t){function i(){return s.collectionGet(o,n).then(e).catch(t)}i(),s.webSocket&&(s.webSocket.on(s.CockpitRealTime.events.COLLECTIONS_SAVE_AFTER,i,t),s.webSocket.on(s.CockpitRealTime.events.COLLECTIONS_SAVE_AFTER+"."+o,i,t))},on:function(e,t,i){var o={save:s.CockpitRealTime.events.COLLECTIONS_SAVE_AFTER,preview:s.CockpitRealTime.events.COLLECTIONS_PREVIEW};s.webSocket&&s.webSocket.on(o[e],t,i)}}}},{key:"regionGet",value:function(e,t){return this.fetchDataText(""+this.endpoints.regionsGet+e,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(t)})}},{key:"singletonList",value:function(){return this.fetchData(this.endpoints.singletonsListSingletons,{method:"GET"})}},{key:"singletonGet",value:function(e,t){return this.fetchData(""+this.endpoints.singletonsGet+e,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(t)})}},{key:"regionList",value:function(){return this.fetchData(this.endpoints.RegionsListRegions,{method:"GET"})}},{key:"regionData",value:function(e,t){return this.fetchData(""+this.endpoints.regionsData+e,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(t)})}},{key:"region",value:function(i,o){var n=this;return{data:function(e,t){n.regionData(i,o).then(e).catch(t)},get:function(e,t){n.regionGet(i,o).then(e).catch(t)}}}},{key:"formSubmit",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return this.fetchData(""+this.endpoints.formsSubmit+e,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(Object.assign({form:t},i))})}},{key:"assets",value:function(e){return this.fetchData(this.endpoints.cockpitAssets,{method:"GET",headers:{"Content-Type":"application/json"}},e)}},{key:"imageGet",value:function(e,t){var i=t.width,o=t.height,t=t.quality;return this.fetchDataText(this.endpoints.cockpitImage,{method:"GET"},{src:e,w:i,h:o,q:t,d:1})}},{key:"image",value:function(e,t){if(!t||t==={}||t===[])return this.host+"/"+e;if(Array.isArray(t))return this.imageSrcSet(e,t);var i=this.getImageOptions(t),o=i.width,n=i.height,s=i.quality,a=i.pixelRatio,t=void 0===a?1:a,a=i.filters,i=_objectWithoutProperties(i,["width","height","quality","pixelRatio","filters"]),a=(0,_queryString3.stringifyObject)(a);return""+this.host+this.endpoints.cockpitImage+"?"+_queryString2.default.stringify(Object.assign({},this.queryParams,{w:o?Number(o)*t:void 0,h:n?Number(n)*t:void 0,src:e,q:s,d:1,o:1},i))+(a||"")}},{key:"imageSrcSet",value:function(i){var o=this,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];return e?e.map(function(e){if("object"!==(void 0===e?"undefined":_typeof(e)))return o.image(i,{width:e})+" "+e+"w";var t=e.srcSet,e=_objectWithoutProperties(e,["srcSet"]);return o.image(i,e)+" "+(t||e.width?""+(t||e.width+"w"):"")}).join(", "):""}},{key:"authUser",value:function(e,t){return this.fetchData(this.endpoints.cockpitAuthUser,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions({user:e,password:t})})}},{key:"listUsers",value:function(e){return this.fetchData(this.endpoints.cockpitListUsers,{method:"GET",headers:{"Content-Type":"application/json"}},e)}},{key:"setWebsocket",value:function(e){this.CockpitRealTime=require("./CockpitRealTime"),this.webSocket=this.CockpitRealTime({host:e})}}]),r}();CockpitSDK.events={SAVE:"save",PREVIEW:"preview"},exports.default=CockpitSDK,Object.defineProperty(exports,"__esModule",{value:!0}),exports.CockpitRealTime=void 0;var _CockpitRealTime=require("./CockpitRealTime"),_CockpitRealTime2=_interopRequireDefault(_CockpitRealTime),_CockpitSDK=require("./CockpitSDK"),_CockpitSDK2=_interopRequireDefault(_CockpitSDK);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}exports.default=_CockpitSDK2.default,exports.CockpitRealTime=_CockpitRealTime2.default,Object.defineProperty(exports,"__esModule",{value:!0});var stringifyObject=exports.stringifyObject=function(i){return i?Object.keys(i).reduce(function(e,t){return e+"&f["+t+"]="+i[t]},""):void 0};exports.default={};_CockpitSDK=require("../CockpitSDK"),_CockpitSDK2=_interopRequireDefault(_CockpitSDK);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}test("Expect Cockpit.image to return array of numbers",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}).image("bux",[10,20,30]);expect(e).toBe("foo/api/cockpit/image?d=1&lang=biz&o=1&src=bux&token=bar&w=10 10w, foo/api/cockpit/image?d=1&lang=biz&o=1&src=bux&token=bar&w=20 20w, foo/api/cockpit/image?d=1&lang=biz&o=1&src=bux&token=bar&w=30 30w")}),test("Expect Cockpit.image to return height",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}).image("bux",{width:200,height:100});expect(e).toBe("foo/api/cockpit/image?d=1&h=100&lang=biz&o=1&src=bux&token=bar&w=200")}),test("Expect Cockpit.image with pixel ratio",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}).image("bux",{width:200,height:100,pixelRatio:2});expect(e).toBe("foo/api/cockpit/image?d=1&h=200&lang=biz&o=1&src=bux&token=bar&w=400")}),test("Expect Cockpit.image with array to return height",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}).image("bux",[{width:200,height:100},{width:20,height:10}]);expect(e).toBe("foo/api/cockpit/image?d=1&h=100&lang=biz&o=1&src=bux&token=bar&w=200 200w, foo/api/cockpit/image?d=1&h=10&lang=biz&o=1&src=bux&token=bar&w=20 20w")}),test("Expect Cockpit.image with array to return pixel ratio",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}).image("bux",[{pixelRatio:2,width:200,height:100},{pixelRatio:2,width:20,height:10}]);expect(e).toBe("foo/api/cockpit/image?d=1&h=200&lang=biz&o=1&src=bux&token=bar&w=400 200w, foo/api/cockpit/image?d=1&h=20&lang=biz&o=1&src=bux&token=bar&w=40 20w")}),test("Expect Cockpit.image with array to return different srcSet",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}),t={width:200,height:100,srcSet:"1x"},i=Object.assign({},t,{pixelRatio:2,srcSet:"2x"}),i=e.image("bux",[t,i]);expect(i).toBe("foo/api/cockpit/image?d=1&h=100&lang=biz&o=1&src=bux&token=bar&w=200 1x, foo/api/cockpit/image?d=1&h=200&lang=biz&o=1&src=bux&token=bar&w=400 2x")}),test("Expect Cockpit.image to return one filter",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}).image("bux",{filters:{darken:50}});expect(e).toBe("foo/api/cockpit/image?d=1&lang=biz&o=1&src=bux&token=bar&f[darken]=50")}),test("Expect Cockpit.image to return multiple filters",function(){var e=new _CockpitSDK2.default({host:"foo",accessToken:"bar",lang:"biz"}).image("bux",{filters:{darken:50,pixelate:40,desaturate:!0,flip:"x"}});expect(e).toBe("foo/api/cockpit/image?d=1&lang=biz&o=1&src=bux&token=bar&f[darken]=50&f[pixelate]=40&f[desaturate]=true&f[flip]=x")});